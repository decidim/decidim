<%= render layout: "layouts/decidim/shared/layout_user_profile" do %>

  <% add_decidim_page_title(t("notifications_settings", scope: "layouts.decidim.user_profile")) %>
  <% content_for(:subtitle) { t("notifications_settings", scope: "layouts.decidim.user_profile") } %>

  <%= form_for(@notifications_settings, url: notifications_settings_path, method: :put, class: "user-form") do |f| %>
    <div class="form__wrapper">
      <p>
        <%= t("receive_notifications_about", scope:"decidim.notifications_settings.show") %>
      </p>
      <div class="toggle__switch-trigger">
        <label for="dc-<%= :notifications_from_own_activity %>" class="toggle__switch-toggle">
          <input
            <%= %(checked="checked") if :notifications_from_own_activity %>
            id="dc-<%= :notifications_from_own_activity %>"
            type="checkbox"
            name="<%= :notifications_from_own_activity %>"
          >
          <span class="sr-only"></span>
          <span class="toggle__switch-toggle-content">
          </span>
          <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
          <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
        </label>
        <h3 class="toggle__switch-trigger-title">
          <%= t("own_activity", scope:"decidim.notifications_settings.show") %>
        </h3>
      </div>
      <div class="toggle__switch-trigger">
        <label for="dc-<%= :notifications_from_followed %>" class="toggle__switch-toggle">
          <input
            <%= %(checked="checked") if :notifications_from_followed %>
            id="dc-<%= :notifications_from_followed %>"
            type="checkbox"
            name="<%= :notifications_from_followed %>"
          >
          <span class="sr-only"></span>
          <span class="toggle__switch-toggle-content">
          </span>
          <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
          <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
        </label>
        <h3 class="toggle__switch-trigger-title">
          <%= t("everything_followed", scope:"decidim.notifications_settings.show") %>
        </h3>
      </div>
      <p>
        <%= t("notifications_sending_frequency", scope:"decidim.notifications_settings.show") %>
      </p>
      <div class="grid grid-cols-4">
      <%= f.collection_radio_buttons :notifications_sending_frequency, frequencies_collection, :first, :last, { checked: @notifications_settings.notifications_sending_frequency || "daily" } %>
      </div>
      <p>
        <%= t("newsletters", scope:"decidim.notifications_settings.show") %>
      </p>
      <div class="toggle__switch-trigger">
        <label for="dc-<%= :newsletter_notifications %>" class="toggle__switch-toggle">
          <input
            <%= %(checked="checked") if :newsletter_notifications %>
            id="dc-<%= :newsletter_notifications %>"
            type="checkbox"
            name="<%= :newsletter_notifications %>"
          >
          <span class="sr-only"></span>
          <span class="toggle__switch-toggle-content">
          </span>
          <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
          <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
        </label>
        <h3 class="toggle__switch-trigger-title">
          <%= t("newsletter_notifications", scope:"decidim.notifications_settings.show") %>
        </h3>
      </div>
      <p>
        <%= t("direct_messages", scope:"decidim.notifications_settings.show") %>
      </p>
      <div class="toggle__switch-trigger">
        <label for="dc-<%= :allow_public_contact %>" class="toggle__switch-toggle">
          <input
            <%= %(checked="checked") if :allow_public_contact %>
            id="dc-<%= :allow_public_contact %>"
            type="checkbox"
            name="<%= :allow_public_contact %>"
          >
          <span class="sr-only"></span>
          <span class="toggle__switch-toggle-content">
          </span>
          <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
          <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
        </label>
        <h3 class="toggle__switch-trigger-title">
          <%= t("allow_public_contact", scope:"decidim.notifications_settings.show") %>
        </h3>
      </div>

      <% if @notifications_settings.user_is_moderator?(current_user) %>
        <p>
          <%= t("administrators", scope:"decidim.notifications_settings.show") %>
        </p>
        <div class="toggle__switch-trigger">
        <label for="dc-<%= :email_on_moderations %>" class="toggle__switch-toggle">
          <input
            <%= %(checked="checked") if :email_on_moderations %>
            id="dc-<%= :email_on_moderations %>"
            type="checkbox"
            name="<%= :email_on_moderations %>"
          >
          <span class="sr-only"></span>
          <span class="toggle__switch-toggle-content">
          </span>
          <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
          <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
        </label>
        <h3 class="toggle__switch-trigger-title">
          <%= t("email_on_moderations", scope:"decidim.notifications_settings.show") %>
        </h3>
      </div>
        <% Decidim.notification_settings_registry.manifests.filter{ |a| a.settings_area == :administrators }.each do |manifest| %>
          <div class="switch tiny switch-with-label notification_settings">
            <label>
              <%= f.check_box "notification_settings[#{manifest.name}]",
                              checked: ["1", true].include?(current_user.notification_settings.fetch(manifest.name.to_s, manifest.default_value)),
                              label: false,
                              class: "switch-input" %>
              <span class="switch-paddle"></span>
              <span class="switch-label">
                <%= t("notification_settings.#{manifest.name}", scope:"decidim.notifications_settings.show") %>
              </span>
            </label>
          </div>
        <% end %>

      <% end %>

      <% if @notifications_settings.meet_push_notifications_requirements? %>
        <div class="push-notifications js-sw-mandatory">
          <p>
            <%= t("push_notifications", scope:"decidim.notifications_settings.show") %>
          </p>
          <p id="push-notifications-reminder" class="push-notifications__reminder">
            <%= t("push_notifications_reminder", scope:"decidim.notifications_settings.show") %>
          </p>
          <div class="toggle__switch-trigger">
            <label for="dc-<%= :allow_push_notifications %>" class="toggle__switch-toggle">
              <input
                <%= %(checked="checked") if :allow_push_notifications %>
                id="dc-<%= :allow_push_notifications %>"
                type="checkbox"
                name="<%= :allow_push_notifications %>"
              >
              <span class="sr-only"></span>
              <span class="toggle__switch-toggle-content">
              </span>
              <%= icon "check-line", class: "toggle__switch-toggle-icon" %>
              <%= icon "close-line", class: "toggle__switch-toggle-icon" %>
            </label>
            <h3 class="toggle__switch-trigger-title">
              <%= t("allow_push_notifications", scope:"decidim.notifications_settings.show") %>
            </h3>
          </div>
        </div>

        <input id="vapidPublicKey" name="vapid_public_key" type="hidden" value="<%= Base64.urlsafe_decode64(Rails.application.secrets.vapid[:public_key]).bytes %>">
        <input id="subKeys" name="sub_key" type="hidden" value="<%= current_user.notifications_subscriptions.keys %>">
      <% end %>

      <div class="form__wrapper-block flex-col-reverse md:flex-row justify-between">
        <%= f.submit t("update_notifications_settings", scope:"decidim.notifications_settings.show"), class: "button button__sm md:button__lg button__secondary" %>
      </div>
    </div>
  <% end %>
<% end %>
