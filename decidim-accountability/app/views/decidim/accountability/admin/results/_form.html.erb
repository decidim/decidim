<div class="card">
  <div class="card-divider">
    <h2 class="card-title"><%= title %></h2>
  </div>

  <div class="card-section">
    <div class="row column">
      <%= form.translated :text_field, :title, autofocus: true %>
    </div>

    <div class="row column">
      <%= form.translated :editor, :description %>
    </div>

    <% if @form.parent_id %>

      <div class="row column">
        <%= form.select :parent_id, parent_results.map{|result| [translated_attribute(result.title), result.id] }, include_blank: true %>
      </div>

    <% else %>

      <% if current_participatory_space.has_subscopes? %>
        <div class="row column">
          <%= scopes_picker_field form, :decidim_scope_id %>
        </div>
      <% end %>

      <div class="row column">
        <%= form.categories_select :decidim_category_id, current_participatory_space.categories, include_blank: true, disable_parents: false %>
      </div>

    <% end %>

    <div class="row">
      <div class="columns xlarge-6">
        <%= form.date_field :start_date %>
      </div>

      <div class="columns xlarge-6">
        <%= form.date_field :end_date %>
      </div>
    </div>

    <div class="row">
      <div class="columns xlarge-6">
        <%= form.select :decidim_accountability_status_id, statuses.map{|status| [translated_attribute(status.name), status.id, { 'data-progress' => status.progress }] }, include_blank: true %>
      </div>

      <div class="columns xlarge-6">
        <%= form.number_field :progress %>
      </div>
    </div>

    <div class="row column">
      <% if @form.proposals %>
<!-- testing ------------------------------------------------- -->
<% 
# { id: "#{@object_name}_#{attribute}", class: "picker-#{options[:multiple] ? "multiple" : "single"}", name: "#{@object_name}[#{attribute}]" }
picker_options= { id: "decidim_accountability_proposals", class: "picker-multiple", name: 'decidim_accountability[proposals_ids]' }
prompt_params= { url: 'proposals', text: "Add proposal"}
%>
<div id="<%=picker_options[:id]%>" class="data-picker <%=picker_options[:class]%>" data-picker-name="<%=picker_options[:name]%>">
  <div class="picker-values"><% @form.proposals.each do |title, proposal_id| %>
    <div><a href="<%= prompt_params[:url] %>" data-picker-value="<%= proposal_id %>"><%=title%></a></div>
  <% end %></div>
  <div class="picker-prompt"><a href="<%= prompt_params[:url] %>"><%= prompt_params[:text] %></a></div>
</div>
<script type="application/javascript">
$(function() {
  // autocomplete
  $(document).on("open.zf.reveal", "#data_picker-modal", function () {
    $('#data_picker-autocomplete').atwho({
      at: "",
      data: <%= Decidim::Proposals::Proposal.all.collect {|p| {id: p.id, title: p.title}}.to_json.html_safe %>,
      // data: 'proposals.json',
      displayTpl: "<li data-id=\"${id}\">${title}</li>",
      insertTpl: "${title}"
    })
  } );
  $(document).on("inserted.atwho", "#data_picker-autocomplete", function (awEvent, li, evt) {
    console.log("INSERTED::", li.data(), li.data('id'), li.data('itemData'))
    let choose= $('#proposal-picker-choose')
    choose.data('picker-value', li.data('id'))
    choose.data('picker-text', li.data('itemData').title )
    choose.data('picker-choose', '')
  } );
})
</script>
<!-- testing ------------------------------------------------- -->

        <%= form.select :proposal_ids,
                        @form.proposals,
                        {},
                        { multiple: true, class: "chosen-select" }
        %>
      <% end %>
    </div>

    <div class="row column">
      <% if @form.projects %>
        <%= form.select :project_ids,
                        @form.projects,
                        {},
                        { multiple: true, class: "chosen-select" }
        %>
      <% end %>
    </div>

  </div>
</div>
