<div class="card">
  <div class="card-divider">
    <h2 class="card-title"><%= title %></h2>
  </div>

  <div class="card-section">
    <div class="row column">
      <%= form.translated :text_field, :title, autofocus: true %>
    </div>

    <div class="row column">
      <%= form.translated :editor, :description %>
    </div>

    <% if @form.parent_id %>

      <div class="row column">
        <%= form.select :parent_id, parent_results.map{|result| [translated_attribute(result.title), result.id] }, include_blank: true %>
      </div>

    <% else %>

      <% if current_participatory_space.has_subscopes? %>
        <div class="row column">
          <%= scopes_picker_field form, :decidim_scope_id %>
        </div>
      <% end %>

      <div class="row column">
        <%= form.categories_select :decidim_category_id, current_participatory_space.categories, include_blank: true, disable_parents: false %>
      </div>

    <% end %>

    <div class="row">
      <div class="columns xlarge-6">
        <%= form.date_field :start_date %>
      </div>

      <div class="columns xlarge-6">
        <%= form.date_field :end_date %>
      </div>
    </div>

    <div class="row">
      <div class="columns xlarge-6">
        <%= form.select :decidim_accountability_status_id, statuses.map{|status| [translated_attribute(status.name), status.id, { 'data-progress' => status.progress }] }, include_blank: true %>
      </div>

      <div class="columns xlarge-6">
        <%= form.number_field :progress %>
      </div>
    </div>

    <div class="row column">
      <% if @form.proposals %>
<!-- testing ------------------------------------------------- -->
<%= form.label(:proposal_ids) %>
<% 
# { id: "#{@object_name}_#{attribute}", class: "picker-#{options[:multiple] ? "multiple" : "single"}", name: "#{@object_name}[#{attribute}]" }
picker_options= { id: "decidim_accountability_proposals", class: "picker-multiple", name: 'result[proposal_ids]' }
prompt_params= { url: 'proposals', text: "Add proposal"}
%>
<div id="<%=picker_options[:id]%>" class="data-picker <%=picker_options[:class]%>" data-picker-name="<%=picker_options[:name]%>">
  <div class="picker-values"><% @form.proposals.each do |title, proposal_id|
    next unless @form.proposal_ids.include?(proposal_id)
    %>
    <div><a href="<%= prompt_params[:url] %>" data-picker-value="<%= proposal_id %>"><%="##{proposal_id}- #{title}"%></a></div>
  <% end %></div>
  <div class="picker-prompt"><a href="<%= prompt_params[:url] %>"><%= prompt_params[:text] %></a></div>
</div>
<script type="application/javascript">
$(function() {
  // autocomplete
  $(document).on("open.zf.reveal", "#data_picker-modal", function () {
    $('#data_picker-autocomplete').autoComplete({
      minChars: 2,
      // source: function(term, suggest){
      //     term = term.toLowerCase();
      //     var choices = <%= Decidim::Proposals::Proposal.all.collect {|p| [p.title, p.id]}.to_json.html_safe %>
      //     var matches = [];
      //     for (i=0; i<choices.length; i++)
      //         if (~choices[i][0].toLowerCase().indexOf(term)) matches.push(choices[i]);
      //     suggest(matches);
      // },
      source: function(term, response){
        try { xhr.abort(); } catch(e){}
        $.getJSON('proposals.json', { q: term }, function(data){ console.log(data); response(data); });
      },
      renderItem: function (item, search){
        search = search.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        var re = new RegExp("(" + search.split(' ').join('|') + ")", "gi");
        var title= item[0]
        var modelId= item[1]
        var val= '#' + modelId + '- ' + title;
        return '<div class="autocomplete-suggestion" data-model-id="' + modelId + '" data-val="'+title+'">' + val.replace(re, "<b>$1</b>") + '</div>';
      },
      onSelect: function(e, term, item){
        let choose= $('#proposal-picker-choose')
        var modelId= item.data('modelId')
        var val= '#' + modelId + '- ' + item.data('val');
        choose.data('picker-value', modelId)
        choose.data('picker-text', val )
        choose.data('picker-choose', '')
      }
    })
  } );
})
</script>
<!-- testing ------------------------------------------------- -->

        <%#= form.select :proposal_ids,
                        @form.proposals,
                        {},
                        { multiple: true, class: "chosen-select" }
        %>
      <% end %>
    </div>

    <div class="row column">
      <% if @form.projects %>
        <%= form.select :project_ids,
                        @form.projects,
                        {},
                        { multiple: true, class: "chosen-select" }
        %>
      <% end %>
    </div>

  </div>
</div>
