#!/usr/bin/env ruby
# frozen_string_literal: true

require "./lib/decidim/github_manager/querier"
require "./lib/decidim/github_manager/poster"
require "./lib/decidim/git_backport_manager"
require "./lib/decidim/backporter"

github_token = ARGV[0]
version_number = ARGV[1]
pull_request_id = ARGV[2]

if github_token.nil? || version_number.nil? || pull_request_id.nil? || github_token == "--help"
  puts <<~HELP
    Decidim's backporter. It backports a given PR to the specified version number.

    ## Example

        bin/backporter <GITHUB PERSONAL ACCESS TOKEN> <VERSION NUMBER> <PULL REQUEST ID>

    ## Params

    The <GITHUB PERSONAL ACCESS TOKEN> can be obtained from https://github.com/settings/tokens/new
    You'll need to create one with `public_repo` access.

    The <PULL REQUEST ID> is the id of the pull request that you want to make the backport from.
    It should have the "type: fix" label.

    The <VERSION NUMBER> is the version number that you want to do the backport to.
    It must have the format MAJOR.MINOR.

    ## Explanation

    This script will generate a new PR backporting a given PR.
  HELP

  exit 1
end

Decidim::Backporter.new(
  token: github_token,
  pull_request_id: pull_request_id,
  version_number: version_number
).call
