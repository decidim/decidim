---

database:
  override:
    - echo "Skipping DB section."

dependencies:
  pre:
    - curl -o- -L https://yarnpkg.com/install.sh | bash

    - mkdir .chrome
    - (cd .chrome && curl -o- -L https://raw.githubusercontent.com/scheib/chromium-latest-linux/master/update.sh | bash)

    - mkdir .chromedriver
    - curl -OLk https://chromedriver.storage.googleapis.com/2.29/chromedriver_linux64.zip
    - unzip chromedriver_linux64
    - cp chromedriver .chromedriver/

  override:
    - bundle check --path=vendor/bundle ||
      bundle install --path=vendor/bundle --jobs=4
    - yarn

machine:
  environment:
    PATH: "${HOME}/${CIRCLE_PROJECT_REPONAME}/.chrome/latest:${HOME}/${CIRCLE_PROJECT_REPONAME}/.chromedriver:${PATH}"

  node:
    version: 7

test:
  pre:
    - bundle exec rake decidim:generate_test_app

  override:
    - case $CIRCLE_NODE_INDEX in
        0)
          (yarn lint && bundle exec rspec spec) &&
          (yarn test -- decidim-api) &&
          (cd decidim-api && bundle exec rake) &&
          (yarn test -- decidim-core) &&
          (cd decidim-core && bundle exec rake)
          ;;
        1)
          (yarn test -- decidim-admin) &&
          (cd decidim-admin && bundle exec rake) &&
          (yarn test -- decidim-meetings) &&
          (cd decidim-meetings && bundle exec rake)
          ;;
        2)
          (yarn test -- decidim-proposals) &&
          (cd decidim-proposals && bundle exec rake) &&
          (yarn test -- decidim-comments) &&
          (cd decidim-comments && bundle exec rake)
          ;;
        3)
          (yarn test -- decidim-pages) &&
          (cd decidim-pages && bundle exec rake) &&
          (yarn test -- decidim-system) &&
          (cd decidim-system && bundle exec rake) &&
          (yarn test -- decidim-results) &&
          (cd decidim-results && bundle exec rake) &&
          (yarn test -- decidim-budgets) &&
          (cd decidim-budgets && bundle exec rake) &&
          (cd /code && yarn test -- decidim-surveys) &&
          (cd /code/decidim-surveys && bundle exec rake)
          ;;
      esac
