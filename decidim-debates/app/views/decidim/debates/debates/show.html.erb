<% add_decidim_meta_tags({
  description: translated_attribute(debate.description),
  title: present(debate).title,
  url: debate_url(debate.id)
}) %>

<%
edit_link(
  resource_locator(debate).edit,
  :update,
  :debate,
  debate: debate
)
%>

<button class="button button__secondary button__lg" data-drawer-open>open version</button>
<%= render layout: "layouts/decidim/shared/drawer" , locals: { close_url: debate_path } do %>
  <h2 class="h2 decorator">
    <%== present(debate).title(links: true, html_escape: true) %>
  </h2>

  <% debate_presenter = Decidim::Debates::DebatePresenter.new(debate) %>

  <% if debate.closed? %>
    <span class="success label proposal-status">
      <%= t("debate_closed", scope: "decidim.debates.debates.show") %>
    </span>
  <% end %>

  <%= render_debate_description(debate) %>

  <% if debate.closed? %>
    <%= cell("decidim/announcement", { title: t("debate_conclusions_are", scope: "decidim.debates.debates.show", date: l(debate.closed_at, format: :decidim_short)), body: simple_format(translated_attribute(debate.conclusions)) }, callout_class: "success") %>
  <% end %>

  <% if translated_attribute(debate.instructions).present? %>
    <div class="callout secondary">
      <%= decidim_sanitize_editor(simple_format(translated_attribute(debate.instructions), {}, sanitize: false)) %>
    </div>
  <% end %>
  <% if translated_attribute(debate.information_updates).present? %>
    <div class="callout success">
      <%= decidim_sanitize_editor(simple_format(translated_attribute(debate.information_updates), {}, sanitize: false)) %>
    </div>
  <% end %>

  <%= render partial: "decidim/shared/tags", locals: { resource: debate, tags_class_extra: "tags--debate" } %>

  <%= cell "decidim/endorsers_list", debate %>

  <%= comments_for debate %>

  <%= cell("decidim/flag_modal", debate) %>
  <%=
    render partial: "close_debate_modal", locals: {
      debate: debate,
      form: close_debate_form
    }
  %>

  <%= resource_reference(debate) %>

  <% content_for :drawer_aside do %>
    <% if allowed_to?(:edit, :debate, debate: debate) %>
      <%= link_to t("edit_debate", scope: "decidim.debates.debates.show"), edit_debate_path(debate), class: "button button__secondary button__xl w-full mb-4" %>
    <% elsif admin_allowed_to?(:update, :debate, debate: debate) %>
      <%= link_to t("edit_debate", scope: "decidim.debates.debates.show"), resource_locator(debate).edit, class: "button button__secondary button__xl w-full mb-4" %>
    <% end %>
    <% close_debate_action_text = (debate.closed? ? "decidim.debates.debates.show.edit_conclusions" : "decidim.debates.debates.show.close_debate" ) %>
    <% if allowed_to?(:close, :debate, debate: debate) %>
      <button type="button" data-open="closeDebateModal" title="<%= t(close_debate_action_text) %>" aria-controls="closeDebateModal" aria-haspopup="dialog" tabindex="0" class="button button__secondary button__xl w-full mb-4">
        <%= t(close_debate_action_text) %>
      </button>
    <% elsif admin_allowed_to?(:close, :debate, debate: debate) %>
      <%= link_to t(close_debate_action_text), Decidim::EngineRouter.admin_proxy(debate.component).edit_debate_debate_close_path(debate_id: debate.id, id: debate.id), class: "button button__secondary button__xl w-full mb-4" %>
    <% end %>
    <div class="card__list extra">
      <div class="card__list-content">
        <%= cell("decidim/date_range", { start: debate.start_time, end: debate.end_time }) %>

        <%# if endorsements_enabled? && allowed_to?(:endorse, :debate, debate: debate) %>
          <!-- <div class="row collapse buttons__row">
            <div class="column small-12 collapse">
              <%#= endorsement_buttons_cell(debate) %>
            </div>
          </div> -->
        <%# end %>
      </div>
    </div>
    <%= follow_button_for(debate) %>
    <div class="card extra">
      <div class="definition-data">
        <div class="definition-data__item definition-data__item--double">
          <span class="definition-data__title">
            <%= t("participants_count", scope: "decidim.debates.debates.show") %>
          </span>
          <span class="definition-data__number"><%= debate_presenter.participants_count %></span>
        </div>

        <div class="definition-data__item definition-data__item--double">
          <span class="definition-data__title">
            <%= t("groups_count", scope: "decidim.debates.debates.show") %>
          </span>
          <span class="definition-data__number"><%= debate_presenter.groups_count %></span>
        </div>
      </div>
    </div>
  <% end %>

<% end %>
