<% add_decidim_meta_tags({
  description: present(@proposal).body,
  title: present(@proposal).title,
  url: proposal_url(@proposal.id)
}) %>

<%
edit_link(
  resource_locator(@proposal).edit,
  :edit,
  :proposal,
  proposal: @proposal
)
%>

<%
extra_admin_link(
  resource_locator(@proposal).show(anchor: "proposal-answer"),
  :create,
  :proposal_answer,
  { proposal: @proposal },
  { name: t("answer", scope: "decidim.proposals.proposals.show"), icon: "question-answer-line" }
)
%>

<% content_for :css_content do %>
  <%= stylesheet_pack_tag "decidim_proposals", media: "all" %>
<% end %>

<% content_for :js_content do %>
  <%= javascript_pack_tag "decidim_proposals" %>
<% end %>

<% content_for :aside do %>
  <%= render partial: "proposal_aside" %>
<% end %>

<%# REDESIGN_PENDING: define nav_paths %>
<%= render layout: "layouts/decidim/shared/layout_item", locals: { back_path: component_settings.participatory_texts_enabled? ? main_component_path(current_component) : proposals_path } do %>

  <div class="proposal__container">

    <%= render partial: "voting_rules" %>

    <%= emendation_announcement_for @proposal %>

    <% if @proposal.emendation? %>
      <h1 class="h2 decorator"><%= t("changes_at_title", scope: "decidim.proposals.proposals.show", title: present(@proposal.amendable).title(links: true, html_escape: true)) %></h1>
    <% else %>
      <h1 class="h2 decorator"><%= present(@proposal).title(links: true, html_escape: true) %></h1>
    <% end %>

    <% if component_settings.geocoding_enabled? %>
      <%= render partial: "decidim/shared/static_map", locals: { icon_name: "proposals", geolocalizable: @proposal } %>
    <% end %>

    <% unless component_settings.participatory_texts_enabled? %>
      <div class="proposal__author">
        <% # REDESIGN_PENDING: Logic copied from decidim-core/app/cells/decidim/coauthorships_cell.rb
            author = if @proposal.respond_to?(:official?) && @proposal.official?
                        Decidim::Proposals::OfficialAuthorPresenter.new
                      else
                        @proposal.identities.first&.presenter
                      end %>

        <%= cell "decidim/redesigned_author", author, from: @proposal, context_actions: nil, layout: :compact %>

        <% if not ["section","subsection"].include? @proposal.participatory_text_level %>
          <%== cell("decidim/proposals/proposal_m", @proposal, full_badge: true).badge %>
        <% end %>
      </div>
    <% end %>

    <% if @proposal.emendation? %>
      <%= cell("decidim/diff", proposal_presenter.versions.last) %>
    <% elsif not ["section","subsection"].include? @proposal.participatory_text_level %>
      <div class="editor-content">
        <%= render_proposal_body(@proposal) %>
      </div>
    <% end %>

    <% if proposal_has_costs? && current_settings.answers_with_costs? %>
      <%= cell("decidim/proposals/cost_report", @proposal) %>
    <% end %>

    <%= cell("decidim/announcement", proposal_reason_callout_announcement, callout_class: proposal_reason_callout_class) if @proposal.answered? && @proposal.published_state? %>

    <div class="mt-8" data-component="accordion" data-multiselectable="false" data-collapsible="false">
      <ul class="tab-x-container">
        <% tabs.each_with_index do |tab, i| %>
          <li>
            <button id="trigger-<%= tab[:id] %>" class="tab-x" data-controls="panel-<%= tab[:id] %>" data-open="<%= "true" if i == 0 %>">
              <%= icon tab[:icon], class: "text-gray fill-current" %><%= tab[:text] %>
            </button>
          </li>
        <% end %>
      </ul>

      <% panels.each do |panel| %>
        <div id="panel-<%= panel[:id] %>" class="py-8">
          <%= send(panel[:method], *panel[:args]) %>
        </div>
      <% end %>
    </div>

    <%# REDESIGN_PENDING: the next two resources are a simple list of users, as the decidim/meetings/public_participants_list_cell does.
                          It would be useful to move such list to the core, in order to reuse it elsewhere
                          In any case, these blocks should go inside the tabs-panels structure  %>

    <%= cell "decidim/amendable/amendments", @proposal %>

    <%= render partial: "actions" %>

    <% content_for :item_footer do %>
      <%= comments_for @proposal %>

      <div class="mt-8">
        <ul class="drawer-metadata__container" data-metadata-footer>
          <%= content_tag :li, resource_reference(@proposal), class: "drawer-metadata__item" %>
          <%= content_tag :li, resource_version(proposal_presenter, versions_path: proposal_version_path(@proposal, @proposal.versions.count)), class: "drawer-metadata__item" %>

          <% fingerprint_id = dom_id(@proposal, :fingerprint_dialog) %>
          <%= content_tag :li, class: "drawer-metadata__item" do %>
            <%= content_tag :button, t("decidim.fingerprint.check"), data: { dialog_open: fingerprint_id } %>
          <% end %>
       </ul>
       <%= decidim_modal id: fingerprint_id, class: "fingerprint-modal" do %>
         <div data-dialog-container>
           <%= icon "fingerprint-line" %>
           <h2 id="dialog-title-<%= fingerprint_id %>" tabindex="-1" data-dialog-title><%= t "decidim.fingerprint.title" %></h2>
           <div class="fingerprint-modal__container">
             <p id="dialog-desc-<%= fingerprint_id %>"><%= t "decidim.fingerprint.explanation" %></p>
             <div>
               <span class="fingerprint-modal__span"><%= t "decidim.fingerprint.value" %>:</span>
               <code class="fingerprint-modal__code"><%= decidim_html_escape @proposal.fingerprint.value %></code>
             </div>
             <div>
               <span class="fingerprint-modal__span"><%= t "decidim.fingerprint.source" %>:</span>
               <code class="fingerprint-modal__code"><%= @proposal.fingerprint.source %></code>
             </div>
             <p><%= t("decidim.fingerprint.replicate_help", online_calculator_link: link_to(t("decidim.fingerprint.online_calculator_name"), "http://www.md5calc.com/sha256", target: "_blank", rel: "noopener")).html_safe %>
           </div>
         </div>
       <% end %>
      </div>
    <% end %>
  </div>

<% end %>
